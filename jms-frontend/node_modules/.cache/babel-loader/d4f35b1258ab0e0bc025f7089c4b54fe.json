{"ast":null,"code":"import _defineProperty from\"/home/spacey_sooty/Documents/projects/JMS/jms-frontend/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";import _classCallCheck from\"/home/spacey_sooty/Documents/projects/JMS/jms-frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/spacey_sooty/Documents/projects/JMS/jms-frontend/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/home/spacey_sooty/Documents/projects/JMS/jms-frontend/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/spacey_sooty/Documents/projects/JMS/jms-frontend/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import React,{useContext}from\"react\";import{useLocation}from\"react-router-dom\";import JmsWebsocket from\"./ws\";import{jsx as _jsx}from\"react/jsx-runtime\";export var WebsocketContext=/*#__PURE__*/React.createContext(// @ts-ignore\nnull);export function RoleUpdater(props){var location=useLocation();var wsContext=useContext(WebsocketContext);React.useEffect(function(){wsContext.setRole(props.role,location.pathname);},[location.pathname]);return props.children;}export function withRole(role,children){return/*#__PURE__*/_jsx(RoleUpdater,{role:role,children:children});}export var WebsocketManagerComponent=/*#__PURE__*/function(_React$Component){_inherits(WebsocketManagerComponent,_React$Component);var _super=_createSuper(WebsocketManagerComponent);function WebsocketManagerComponent(){var _this;_classCallCheck(this,WebsocketManagerComponent);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.socket=new JmsWebsocket();_this.handles=[];_this.state={send:_this.socket.send,transact:_this.socket.transact,listen:_this.socket.onMessage,unlisten:_this.socket.removeHandles,setRole:_this.socket.updateRole,connected:false};_this.componentDidMount=function(){_this.socket.connect();_this.handles=[_this.socket.onConnectChange(function(connected){return _this.setState({connected:connected});})];};_this.componentWillUnmount=function(){_this.socket.close();};return _this;}_createClass(WebsocketManagerComponent,[{key:\"render\",value:function render(){return/*#__PURE__*/_jsx(WebsocketContext.Provider,{value:this.state,children:/*#__PURE__*/_jsx(RoleUpdater,{role:\"Unknown\",children:this.props.children})});}}]);return WebsocketManagerComponent;}(React.Component);;export var WebsocketComponent=/*#__PURE__*/function(_React$Component2){_inherits(WebsocketComponent,_React$Component2);var _super2=_createSuper(WebsocketComponent);function WebsocketComponent(){var _this2;_classCallCheck(this,WebsocketComponent);for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}_this2=_super2.call.apply(_super2,[this].concat(args));_this2.context=void 0;_this2.handles=[];_this2.listen=function(path,key){var fn=function fn(data){_this2.setState(_defineProperty({},key,data));};return _this2.listenFn(path,fn);};_this2.listenFn=function(path,fn){return _this2.context.listen(path,fn);};_this2.send=function(msg){return _this2.context.send(msg);};_this2.transact=function(msg,path){return _this2.context.transact(msg,path);};_this2.isConnected=function(){return _this2.context.connected;};_this2.componentWillUnmount=function(){_this2.context.unlisten(_this2.handles);};return _this2;}return _createClass(WebsocketComponent);}(React.Component);WebsocketComponent.contextType=WebsocketContext;","map":{"version":3,"names":["React","useContext","useLocation","JmsWebsocket","WebsocketContext","createContext","RoleUpdater","props","location","wsContext","useEffect","setRole","role","pathname","children","withRole","WebsocketManagerComponent","socket","handles","state","send","transact","listen","onMessage","unlisten","removeHandles","updateRole","connected","componentDidMount","connect","onConnectChange","setState","componentWillUnmount","close","Component","WebsocketComponent","context","path","key","fn","data","listenFn","msg","isConnected","contextType"],"sources":["/home/spacey_sooty/Documents/projects/JMS/jms-frontend/src/support/ws-component.tsx"],"sourcesContent":["import React, { useContext } from \"react\";\nimport { useLocation } from \"react-router-dom\";\nimport { ResourceRole, WebsocketMessage2JMS, WebsocketMessage2UI } from \"ws-schema\";\nimport JmsWebsocket, { CallbackFn, TransactPromise } from \"./ws\";\n\nexport type WebsocketContextT = {\n  send: (msg: WebsocketMessage2JMS) => void,\n  transact: <T>(msg: WebsocketMessage2JMS, path?: string[]|string) => TransactPromise<T>,\n  listen: <T>(path: string|string[], callback: CallbackFn<T>) => string,\n  unlisten: (paths: string[]) => void,\n  setRole: (role: ResourceRole, location: string) => void,\n  connected: boolean\n};\n\nexport const WebsocketContext = React.createContext<WebsocketContextT>(\n  // @ts-ignore\n  null\n);\n\nexport function RoleUpdater(props: { role: ResourceRole, children: React.ReactElement }) {\n  let location = useLocation();\n  let wsContext = useContext(WebsocketContext);\n\n  React.useEffect(() => {\n    wsContext.setRole(props.role, location.pathname);\n  }, [location.pathname]);\n\n  return props.children;\n}\n\nexport function withRole(role: ResourceRole, children: React.ReactElement) {\n  return <RoleUpdater role={role}>\n    { children }\n  </RoleUpdater>\n}\n\nexport class WebsocketManagerComponent extends React.Component<{ children: React.ReactElement }, WebsocketContextT> {\n  socket: JmsWebsocket = new JmsWebsocket();\n  handles: string[] = [];\n\n  readonly state: WebsocketContextT = {\n    send: this.socket.send,\n    transact: this.socket.transact,\n    listen: this.socket.onMessage,\n    unlisten: this.socket.removeHandles,\n    setRole: this.socket.updateRole,\n    connected: false\n  };\n\n  componentDidMount = () => {\n    this.socket.connect();\n    this.handles = [\n      this.socket.onConnectChange(connected => this.setState({ connected }))\n    ]\n  }\n\n  componentWillUnmount = () => {\n    this.socket.close();\n  }\n\n  render() {\n    return <WebsocketContext.Provider value={this.state}>\n      <RoleUpdater role=\"Unknown\">\n        { this.props.children }\n      </RoleUpdater>\n    </WebsocketContext.Provider>\n  }\n};\n\nexport abstract class WebsocketComponent<P={},S={}> extends React.Component<P,S> {\n  static contextType = WebsocketContext;\n  context!: WebsocketContextT;\n\n  handles: string[] = [];\n\n  listen = <K extends keyof S>(path: string|string[], key: K) => {\n    const fn = (data: S[K]) => {\n      this.setState({ [key]: data } as Pick<S, K>)\n    };\n    return this.listenFn<S[K]>(path, fn);\n  }\n  \n  listenFn = <T,>(path: string|string[], fn: (data: T) => void) => {\n    return this.context.listen<T>(path, fn);\n  }\n\n  send = (msg: WebsocketMessage2JMS) => this.context.send(msg);\n  transact = <T,>(msg: WebsocketMessage2JMS, path?: string[]|string): TransactPromise<T> => this.context.transact<T>(msg, path)\n\n  isConnected = () => this.context.connected;\n\n  componentWillUnmount = () => {\n    this.context.unlisten(this.handles)\n  };\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}